<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat U. Guayaquil</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
   
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>Bienvenido al Chat</h2>
            <p style="color: #aaa; font-size: 0.9em;">Ingresa tu nombre para unirte a la sala.</p>
            <input type="text" id="username-input" class="login-input" placeholder="Tu Nombre..." autocomplete="off">
            <button id="btn-join" class="btn-enter">Ingresar al Chat</button>
        </div>
    </div>

    <div id="chat-container">
        <aside id="sidebar">
            <h3>Usuarios en línea <span id="contador-usuarios" style="font-size: 1.5em; opacity: 0.7;">(0)</span></h3>
            <ul id="user-list"></ul>
        </aside>

        <main id="main-chat">
            <div id="messages-area"></div>
            
            <form id="input-area">
                <input id="input-message" autocomplete="off" placeholder="Escribe un mensaje..." />
                <button id="btn-send">Enviar</button>
            </form>
        </main>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // Elementos del DOM
        const loginScreen = document.getElementById('login-screen');
        const chatContainer = document.getElementById('chat-container');
        const usernameInput = document.getElementById('username-input');
        const btnJoin = document.getElementById('btn-join');
        const messagesArea = document.getElementById('messages-area');
        const userList = document.getElementById('user-list');
        const form = document.getElementById('input-area');
        const inputMessage = document.getElementById('input-message');

        let myName = "";

        // --- LÓGICA DE LOGIN ---
        btnJoin.addEventListener('click', joinChat);
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinChat();
        });

        function joinChat() {
            const name = usernameInput.value.trim();
            if (name) {
                myName = name;
                socket.emit('nuevo_usuario', name); // Enviar al servidor
                
                // Animación de transición
                loginScreen.style.opacity = '0';
                setTimeout(() => {
                    loginScreen.style.display = 'none';
                    chatContainer.style.opacity = '1';
                    chatContainer.style.pointerEvents = 'auto';
                }, 500);
            } else {
                alert("Por favor, escribe un nombre.");
            }
        }

        // --- LÓGICA DEL CHAT ---

        // Enviar mensaje
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (inputMessage.value) {
                socket.emit('mensaje_chat', inputMessage.value);
                inputMessage.value = '';
            }
        });

        // Recibir mensajes
        socket.on('mensaje_chat', (data) => {
            const msgDiv = document.createElement('div');
            
            // Decidir si el mensaje es mío o de otro
            const isMine = data.usuario === myName;
            msgDiv.classList.add('message', isMine ? 'mine' : 'others');

            msgDiv.innerHTML = `
                <span class="user-name">${isMine ? 'Tú' : data.usuario}</span>
                ${data.texto}
            `;
            
            messagesArea.appendChild(msgDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight; // Auto-scroll abajo
        });

        // Mensajes del Sistema (Entrada/Salida)
        socket.on('mensaje_sistema', (texto) => {
            const sysDiv = document.createElement('div');
            sysDiv.classList.add('system-message');
            sysDiv.textContent = texto;
            messagesArea.appendChild(sysDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        });

        // Actualizar lista de usuarios
        socket.on('actualizar_lista', (usuarios) => {
            const userList = document.getElementById('user-list');
            const contador = document.getElementById('contador-usuarios'); // <--- 1. Referencia al contador
            
            // 2. Actualizamos el número contando el tamaño del array (.length)
            contador.textContent = `(${usuarios.length})`;

            userList.innerHTML = "";
            usuarios.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user;
                userList.appendChild(li);
            });
        });

    </script>
</body>
</html>